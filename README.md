# Pelion Webhook

Callback handler for the Pelion [event notification channel](https://www.pelion.com/docs/device-management/current/integrate-web-app/event-notification.html) implemented using Amazon AWS [API Gateway](https://aws.amazon.com/api-gateway/) and [Lambda](https://aws.amazon.com/lambda/). Notifications and device registration messages are parsed and sent to [Elasticsearch](https://aws.amazon.com/elasticsearch-service/) for storage and visualization. 

# Installation

## Prerequisites

* AWS account with access to:
  * API Gateway.
  * Lambda.
  * CloudWatch (for logging).
  * IAM (for creating roles).
  * Elasticsearch.
* Pelion account with access to API key.
* Command terminal with access to Curl.

## Setup

### AWS CloudWatch Access

The Lambda creation tool can fail to create a REST API trigger in API Gateway due to missing permissions. Follow this guide to enable CloudWatch logging from API Gateway: https://aws.amazon.com/premiumsupport/knowledge-center/api-gateway-cloudwatch-logs/.

### AWS Elasticsearch

On the Elasticsearch dashboard, create a new domain with resource settings suitable for the project. For testing purposes, the smallest cluster setting should be sufficient and covered by the free tier. Use "Allow open access to domain" for testing. Note that anyone with the autogenerated URL (including the Lambda function) will have permission to read and write to this instance. 

Take a note of the URL labled "Endpoint", since this will be used by the Lambda function for data insertion, and the URL labled "Kibana", which will be used for visualizing data. 

Open Kibana and go to the "Dev Tools" section. In the console, create three new indices using the commands below one at a time:

#### Notifications index
```
PUT /notifications
{
  "mappings" : {
    "properties" : {
      "time" : {
        "type" : "date"
      },
      "endpoint" : {
        "type" : "text"
      },
      "path" : {
        "type" : "text"
      },
      "value" : {
        "type" : "double"
      }
    }
  }
}
```

#### Device information index
```
PUT /devices
{
  "mappings" : {
    "properties" : {
      "time" : {
        "type" : "date"
      },
      "endpoint" : {
        "type" : "text"
      },
      "original-ep" : {
        "type" : "text"
      },
      "ept" : {
        "type" : "text"
      },
      "resources" : {
        "type" : "text"
      }
    }
  }
}
```

#### Device registration index
```
PUT /registrations
{
  "mappings" : {
    "properties" : {
      "time" : {
        "type" : "date"
      },
      "endpoint" : {
        "type" : "text"
      },
      "value" : {
        "type" : "integer"
      }
    }
  }
}
```

### AWS Lambda

* On the Lambda dashboard, choose "Create Function" and "Author From Scratch". Pick a suitable function name, at least Node.js 12.x, and create or reuse a role with basic Lambda execution rights. 
* Copy the two files from this repository named `index.js` and `elasticsearch.js` into the Lambda workspace. Ensure the field "Handler" is set to `index.handler`.
* Under "Environment Variables", create a new variable `ELASTICSEARCH_DOMAIN` with the Elasticsearch "Endpoint" name we got above.
* Under "Basic Settings", the default 128 MiB RAM and 3 second timeout should be sufficient for testing.
* At the top, under "Designer", start the "Trigger" template and choose "API Gateway".

### AWS API Gateway

* In the "Add trigger" template, create a new "REST API" with "Open with API key" under security. 
* Enable logging. Note, this may fail due to missing permissions. Follow the guid above about CloudWatch roles and try again.
* Note the "API Endpoint" URL and the "API key".

### Pelion Cloud REST API

From the Arm Pelion Device Management portal, create a new API key. From a command terminal execute:

```
curl -X PUT https://api.us-east-1.mbedcloud.com/v2/notification/callback \
-H 'Authorization: Bearer PELION_API_KEY' \
-H 'content-type: application/json' \
-d '{
"url": "AWS_API_ENDPOINT",
"headers": { "x-api-key": "AWS_API_KEY"}
}'
```

Where `PELION_API_KEY` is the API key from Pelion Device Management portal, `AWS_API_ENDPOINT` and `AWS_API_KEY` are the API endpoint and key retrieved from AWS API Gateway above. 

Next, enable pre-subscriptions for LwM2M resources that should be stored in Elasticsearch:
```
curl -X PUT https://api.us-east-1.mbedcloud.com/v2/subscriptions \
-H 'Authorization: Bearer PELION_API_KEY' \
-H 'content-type: application/json' \
-d '[
       {
         "endpoint-name": "*",
         "resource-path": ["/object/instance/resource", ... ] 
       }
    ]'
```

See [here](https://www.pelion.com/docs/device-management/current/connecting/resource-change-webapp.html) for the full syntax.

Whenever a device connected to Pelion Device Management sends numerical values over one of the pre-subscribed LwM2M resources, the data can be viewed using Kibana.

### AWS Kibana

* Under "Management" and "Index Patterns", create three new index patterns, one for each index: notifications, devices, registrations using `time` as the time filter. 
* Raw data can be accessed under "Discover".
* Graphs can be created under "Visualize".
